<% content_for :head do %>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      makeSubmissionTable(document.getElementById('submission-table'),
        {
          assignment_id: <%= @assignment.id %>,
          show_grace_tokens:
            <%= @assignment.submission_rule.type == 'GracePeriodSubmissionRule' %>,
          show_sections:
            <%= Section.exists? %>,
          show_members:
            <%= @assignment.group_max > 1 || @assignment.scanned_exam? %>,
          is_admin: <%= @current_user.admin? %>,
          can_run_tests: <%= @current_user.admin? && @assignment.enable_test %>,
        }
      );
    });
  </script>
<% end %>

<% content_for :title do %>
  <% if @assignment.is_peer_review? %>
    <%=t('peer_review.reviews')%>: <%= sanitize(@assignment.parent_assignment.short_identifier) %>
  <% else %>
    <%= t('browse_submissions.submissions',
          short_identifier: sanitize(@assignment.short_identifier)) %>
  <% end %>
  <div class='title-help submissions_help'>
    <p class='help-message-title submissions_help'>
      <% if @current_user.ta? %>
        <%= t('assignment.help.submissions_graders') %>
      <% else %>
        <%= t('assignment.help.submissions_admins') %>
      <% end %>
    </p>
  </div>
<% end %>


<% @heading_buttons = [] %>

<% unless @assignment.is_peer_review? %>
  <% if @current_user.admin? %>
    <% @heading_buttons += [
      { link_text: t('browse_submissions.detailed_csv_report'),
        link_path: summary_assignment_path(@assignment) },
      { link_text: t('browse_submissions.repo_list'),
        link_path: download_repo_list_assignment_submissions_path(@assignment) },
      { link_text: t('browse_submissions.repo_checkout_file'),
        link_path: download_repo_checkout_commands_assignment_submissions_path(@assignment) }
    ] %>
  <% end %>

  <% @heading_buttons.push(
    { link_text: t('download_the', item: t('browse_submissions.all_submissions')),
      link_path: download_groupings_files_assignment_submissions_path,
      html_options: { id: 'download_all_submissions_link' } }
  ) %>
<% end %>

<% content_for :additional_headings do %>
  <% if @current_user.ta? %>
    <span class='menu_bar'></span>
    <%= t('browse_submissions.how_many_marked',
          num_marked: @assignment.get_num_marked(@current_user.id),
          num_assigned: @assignment.get_num_assigned(@current_user.id)) %>
  <% end %>
<% end %>

<div id='submission-table'></div>

<script>
  $(document).ready(function() {
    var downloadGroupingsFiles = function() {
      window.location.href = "<%= download_groupings_files_assignment_submissions_path %>";
    };

    $('#download_all_submissions_link').on('click', function () {
      $.ajax({
        url: '<%= check_collect_status_assignment_submissions_path %>',
        type: 'GET',
        success: function (data) {
          if (data.collect_status !== true) {
            var proceed = confirm('<%= t('collect_submissions.collection_incomplete_warning') %>');

            if (proceed !== true) {
              return;
            }
          }
          downloadGroupingsFiles();
        },
        error: function () {
          alert('<%= t('collect_submissions.check_collection_status_error') %>');
        }
      });
      return false;
    });
  });
</script>
