<script>
  /*
    This file contains the Javascript code necessary for the functionality
    of the annotation context menu. For the annotation context menu to
    function properly, these dependencies are necessary:

    Context-Menu and library related:
      * jquery.ui-contextmenu.min.js (..\app\assets\javascripts\)
        * Depends on jQuery and jQuery-ui
      * context_menu.css (..\app\assets\stylesheets\)

    Context-Menu button functionality:
      * _annotations.js.erb (..\app\views\results\common\)

     */
  (function() {
    var released_to_students = <%= result.released_to_students %>;
    if (released_to_students) return;
    var menu_items = {
      new_annotation: {
        title: 'New Annotation',
        cmd: 'new_annotation',
        action: make_new_annotation,
        disabled: true
      },
      common_annotations: {
        title: 'Common Annotations <kbd>></kbd>',
        cmd: 'common_annotations',
        disabled: true
      },
      delete_annotation: {
        title: 'Delete Annotation',
        cmd: "delete_annotation",
        action: function(event, ui) {
          var clicked_element = $(ui.target);
          var annot_id = '';
          var sub_file_id = $('#select_file_id').val();
          if (annotation_type === ANNOTATION_TYPES.CODE) {
            $.each(clicked_element[0].attributes, function(index, attr) {
              if (attr.nodeName.toLowerCase()
                      .indexOf('data-annotationid') != -1) {
                annot_id = attr.value;
                // Continue iteration in case of multiple annotations
              }
            });
          } else {
            annot_id = clicked_element.attr('id')
                                      .replace('annotation_holder_', '');
          }

          if (annot_id !== null && annot_id.length !== 0 &&
              sub_file_id !== null && sub_file_id.length !== 0) {
            var query_str_params = [
              ['id=' + annot_id],
              ['submission_file_id=' + sub_file_id],
              ['result_id=<%= result.id %>'],
              ['assignment_id=<%= result.submission.grouping.assignment.id %>']
            ];
            $.ajax({
              url: '<%= annotations_path %>?' + query_str_params.join('&'),
              method: 'POST',
              data: { _method: 'delete' },
              dataType: 'script'
            });

          }
          return;
        },
        disabled: true
      },
      separator: {
        title: '----'
      },
      copy: {
        title: 'Copy',
        cmd: 'copy',
        action: function(){ document.execCommand('copy'); },
        disabled: true
      }
    }

    $(document).contextmenu({
      delegate: '#codeviewer, #sel_box',
      autoFocus: false,
      preventContextMenuForPopup: true,
      preventSelect: false,
      taphold: true,
      ignoreParentSelect: false,
      show: {
        effect: 'slidedown',
        duration: 'fast'
      },
      menu: [
        menu_items.new_annotation,
        menu_items.common_annotations,
        menu_items.delete_annotation,
        menu_items.separator,
        menu_items.copy,
      ],
      beforeOpen: function (event, ui) {
        ui.menu.zIndex($(event.target).zIndex() + 1);

        // Enable annotation menu items only if a selection has been made
        var selection_exists = (function() {
          if (annotation_type === ANNOTATION_TYPES.CODE) {
            return window.getSelection().toString() !== '';
          } else if (annotation_type === ANNOTATION_TYPES.PDF) {
            return !!get_pdf_box_attrs();
          } else {
            return !!get_selection_box_coordinates();
          }
        })();
        $(document).contextmenu('enableEntry', 'new_annotation',
                                selection_exists);
        $(document).contextmenu('enableEntry', 'common_annotations',
                                selection_exists);
        $(document).contextmenu('enableEntry', 'copy',
                                selection_exists);

        var has_common_annot = $(document).contextmenu('getMenu')
                                          .find('.has_common_annotations')
                                          .length > 0;
        $(document).contextmenu('showEntry', 'common_annotations',
                                has_common_annot);

        // Enable "delete" menu item if an annotation was clicked.
        var annotation_selected = (function() {
          var clicked_element = $(ui.target);
          if (annotation_type === ANNOTATION_TYPES.CODE) {
            return clicked_element.hasClass('source-code-glowing-1');
          } else {
            return clicked_element.hasClass('annotation_holder');
          }
        })();
        $(document).contextmenu('enableEntry', 'delete_annotation',
                                annotation_selected);
      }
    });
  })();

  (function() {
   var common_annotations = [
    <% annotation_categories.each do |annotation_category| %>
      {
        title: '<%= truncate(annotation_category.annotation_category_name, length: 40) %> <kbd>></kbd>',
        cmd: 'annotation_category_<%= annotation_category.id %>',
        action: function(event, ui){ return false; },
        children: [
        <% if annotation_category.annotation_texts.empty? %>
          {
            title: '<%= t('marker.annotation.no_annotation_in_this_category') %>',
            action: function(event, ui){ return false; }
          }
        <% end %>

        <% annotation_category.annotation_texts.each do |annotation_text| %>
          {
            title: '<%= truncate(annotation_text.content, length: 70) %>',
            cmd: 'annotation_text_<%= annotation_text.id %>',
            action: function(){
              add_existing_annotation(<%= annotation_text.id %>, <%= result.id %>);
            }
          },
        <% end %>
        ]
      },
    <% end %>
    ];

    if (common_annotations.length > 0) {
      $(document).contextmenu("setEntry", "common_annotations", {
        title: 'Common Annotations <kbd>></kbd>',
        cmd: 'common_annotations',
        addClass: 'has_common_annotations',
        action: function(event, ui){ return false; },
        children: common_annotations,
        disabled: true
      });
    }
  })();
</script>