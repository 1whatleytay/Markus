<% content_for :head do %>
  <%= javascript_include_tag 'Results/file_selector' %>
  <%= render partial: 'results/common/included_annotations',
             formats: [:js],
             handlers: [:erb] %>
<% end %>

<%= form_tag(download_assignment_submission_result_path(
                     @assignment.id, @grouping.current_submission_used.id,
                     @grouping.current_submission_used.get_latest_result.id)) do %>
  <%= hidden_field_tag :include_annotations,
                       true,
                       id: 'download_include_annotations' %>
  <div class='file_selector'>
    <input type='button'
           onclick='bump_select("select_file_id", -1, "back_button", "next_button"); return false;'
           value='←'
           id='back_button'
           disabled>

     <% h = Hash.new %> 

     <% files.each do |file| %>
       <% innermost_dir = h %>
       <% innermost_dir["files"] = Array.new %>
       <% folders = file.path.split('/') %>
       <% folders.each do |folder_name| %>
         <% if !innermost_dir.key?(folder_name) %>
           <%= puts "don't have folder ", folder_name %>
           <% innermost_dir[folder_name] = Hash.new %>
           <% innermost_dir[folder_name]["files"] = Array.new %>
         <% end %>
         <% innermost_dir = innermost_dir[folder_name] %>
         <% innermost_dir["files"].push(file.filename) %>
       <% end %>
     <% end %>


    <div class="nested_files">
      <ul>
          <li>
              <a>Outer Dir 1</a>
              <ul>
                  <a>Inner Dir</a>
                  <ul>
                      <li>File 1</li>  
                      <li>File 2</li>          
                  </ul>  
                  <li>File X</li>  

                  <a>Inner Dir 2</a>
                  <ul>
                      <li>File 3</li>  
                      <li>File 4</li>          
                  </ul> 
                  <li>File Y </li>            
              </ul>                
          </li>
          
          <li>
              <a>Outer Dir 2</a>
              <ul>
                  <li>File Z</li>      
              </ul>                
          </li>
      </ul>
    </div> 




    <input type='button'
           onclick='bump_select("select_file_id", 1, "back_button", "next_button"); return false;'
           value='→'
           id='next_button'>
  </div>




  <script type="text/javascript">

  jQuery('.nested_files a').click(function() {
    jQuery(this).next().toggle();
  });
  </script>


  <div class='download_file'>

    <%= submit_tag t(:download), onclick: 'with_annotations();' if can_download && !files.empty? %>

    <%= label_tag('include_annotations',
                  t('marker.include_annotations'),
                  class: 'inline_label') if can_download && !files.empty? %>
    <%= check_box_tag('include_annotations',
                      true,
                      false,
                      id: 'include_annotations',
                      onclick: 'annotations_included();',
                      class: 'inline_checkbox') if can_download && !files.empty? %>

    <%= submit_tag t('browse_submissions.download_all_files'),
                   name: 'download_zip_button',
                   onclick: 'with_annotations();' unless files.empty? %>
  </div>
<% end %>
