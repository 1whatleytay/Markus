<%= stylesheet_link_tag("livepipe/tabs") %>
<%= javascript_include_tag "livepipe/livepipe.js" %>
<%= javascript_include_tag "livepipe/window.js" %>
<%= javascript_include_tag "livepipe/tabs.js" %>

<script>

var modal = null;
var modalCreate = null;
var modalAssignmentGroupReUse = null;

function make_new_group() {
   if(<%= @assignment.group_name_autogenerated == false%>)
   {
      modalCreate.open();
      $('new_group_name').setValue('');
      return false;
   } else {
     <%= remote_function(
       :url  => { :action => 'add_group', :id => @assignment.id})
     %>
   }
}

function submit_new_group(new_group_name) {

  //close the dialog
  modalCreate.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'add_group', :id => @assignment.id},
    :with => "'&new_group_name=' + new_group_name")
  %>
}

function rename_group(id) {
      modal.open();
      $grouping_id = id;
      $('new_groupname').setValue('');
      return false;
}

function submit_rename_group(new_groupname, grouping_id) {

  //close the dialog
  modal.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'rename_group', :id => @assignment.id},
    :with => "'&grouping_id=' + grouping_id +  '&new_groupname=' + new_groupname")
  %>
}

function assignment_group_use() {
    modalAssignmentGroupReUse.open();
    $('clone_groups_assignment_id').setValue('');
    return false;
 }

function submit_assignment_group_use(clone_groups_assignment_id) {

  //close the dialog
  modalAssignmentGroupReUse.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'use_another_assignment_groups', :id => @assignment.id},
    :with => "'&clone_groups_assignment_id=' + clone_groups_assignment_id")
  %>

}


document.observe("dom:loaded", function(){
    //Create the modal dialog
  modalCreate = new Control.Modal($('create_group_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalCreate',
    fade:false
 
  });

  modal = new Control.Modal($('rename_group_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modal',
    fade:false
 
  });

 modalAssignmentGroupReUse = new Control.Modal($('assignment_group_use_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalAssignmentGroupReUse',
    fade:false
  });
})
</script>

<script type="text/javascript" language="JavaScript">
  function clearText(id) {
    $("student_user_name").value = "";
  }
  function focusText(id) {
    $("student_user_name").focus();
  }
</script>

<h1>Manage Groups for <%= h(sanitize(@assignment.name)) %></h1>
   <%= button_to_function "Use another assignment's groups", 'assignment_group_use(); return
    false;' %> 
<div class="colsLeftHeavy">

  <div class="colLeft"><div class="wrapLeft">
  
    <h2>Groups for <%= h(sanitize(@assignment.name)) %></h2>

      <% if flash[:upload_notice] -%>
          <p class="success"><%= h(flash[:upload_notice]) %></p>
      <% end -%>
      
      <% if flash[:edit_notice] -%>
        <p class="success"><%= h(flash[:edit_notice]) %></p>
      <% end -%>

      <% if flash[:fail_notice] -%>
        <p class="error"><%= h(flash[:fail_notice]) %></p>
      <% end -%>
  
    
    <p>
    <%= button_to_function "Add a new group", 'make_new_group(); return
    false;'  %>
    </p>
    
 
  <div id="assignment_group_use_dialog">
      <h2>Reuse Groups</h2>
    <p>
      <fieldset>
      <p>Which assignments groups would you like to use?</p>
      
      <select id="clone_groups_assignment_id" name="clone_groups_assignment_id">
        <% @all_assignments.each do |an_assignment| %>
          <% if an_assignment != @assignment %>
          <option value="<%=h(an_assignment.id)%>"><%=h(an_assignment.name)%></option>
          <% end %>
        <% end %>
      </select>
      </fieldset>
    </p>
    <p class="p_modal">
   <%= button_to_function 'Submit',
       "if (confirm('This will delete all the groups linked to this assignment. Continue?' )) submit_assignment_group_use(escape($F('clone_groups_assignment_id')))"
   %>        
   <%= button_to_function "cancel", 'modalAssignmentGroupReUse.close()'%>
    </p>    
  </div>
 
  <div id="create_group_dialog">
      <h2>Create new group</h2>
    <p>
      <fieldset>
      Group Name
      <input type="text" id="new_group_name"></input>
      </fieldset>
    </p>
    <p class="p_modal">
    <%= button_to_function "Create new group",
"submit_new_group(escape($F('new_group_name')));" %>       
    <%= button_to_function "Cancel", 'modalCreate.close()'%> 
       </p>
      
  </div>
 
 <div id="rename_group_dialog">
      <h2>Rename group</h2>
    <p>
      <fieldset>
      Group Name
      <input type="text" id="new_groupname"></input>
      </fieldset>
    </p>
    <p class="p_margin">
        <button
	onClick="submit_rename_group(escape($F('new_groupname')),
($grouping_id));">Rename group</button>
        <button onClick="modal.close();">Cancel</button>
      </p> 
  </div> 
  
    <div class="section">
      
      <div id="groups_container">
      
        <ul class="groups" id="groups">
          <% @groupings.each do |grouping| -%>
            <%= render :partial => "groups/manage/group", :locals => {:grouping => grouping} %>
         <% end -%>
        </ul>
      
      </div>

    </div>
    
  </div></div> <!-- colLeft -->

  <div class="colRight">

    <% # order of processing students is important. we go through each member 
       # one by one and delete them above from the list of students 
       # if they are already in a group
       # See manage/_group.html.erb
    %>
    
    <h2>Users not in group:</h2>
    
    <div class="section">

      <div id="student_container">
      
        <ul id="student_list">
          <% @students.each do |user_id, s| -%>
            <li id="user_<%= h(s.user_name) %>"><%= h(s.user_name) %></li>
          <% end -%>
        </ul>
      </div>
    
    </div>
    
    <h2>Upload a Group List</h2>
    
    <div class="section">
    
      <div id="upload">
        <p>
          Select a CSV file form:<br />
          <code>group_name,user_name,user_name ... </code><br />
        </p>
        <% form_for :group, :html => {:multipart => true},
                             :url => { :controller=>"groups",
                                       :action => 'csv_upload',
                                       :id => @assignment.id } do |f| -%>
           <p><%= f.file_field :grouplist, :size => 0 %>
              <%= submit_tag("Submit") %></p>							
        <% end %>
      </div> <!-- Upload -->
      
      <p id="download">
        <%= link_to 'Download group list CSV Format', {:controller=>"groups", :action=>"download_grouplist", :id=> @assignment.id}%>
      </p>
      
    </div>
      
  </div> <!-- colRight -->

</div> <!-- ColsLeftHeavy -->
